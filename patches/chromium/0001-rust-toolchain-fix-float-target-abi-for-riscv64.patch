From 130112578f993e4c3d6a6e4e7cfb68c9e060d1aa Mon Sep 17 00:00:00 2001
From: kxxt <rsworktech@outlook.com>
Date: Sat, 10 Feb 2024 12:55:08 +0100
Subject: [PATCH] rust toolchain: fix float target-abi for riscv64

---
 tools/rust/build_rust.py | 21 ++++++++++++++++-----
 1 file changed, 16 insertions(+), 5 deletions(-)

diff --git a/tools/rust/build_rust.py b/tools/rust/build_rust.py
index e0374f04ea613..31d7ca20a1e1e 100755
--- a/tools/rust/build_rust.py
+++ b/tools/rust/build_rust.py
@@ -672,11 +672,11 @@ def main():
         return 1
 
     debian_sysroot = None
-    if sys.platform.startswith('linux') and not args.sync_for_gnrt:
-        # Fetch sysroot we build rustc against. This ensures a minimum supported
-        # host (not Chromium target). Since the rustc linux package is for
-        # x86_64 only, that is the sole needed sysroot.
-        debian_sysroot = DownloadDebianSysroot('amd64')
+    # if sys.platform.startswith('linux') and not args.sync_for_gnrt:
+    #     # Fetch sysroot we build rustc against. This ensures a minimum supported
+    #     # host (not Chromium target). Since the rustc linux package is for
+    #     # x86_64 only, that is the sole needed sysroot.
+    #     debian_sysroot = DownloadDebianSysroot('amd64')
 
     # Require zlib compression.
     if sys.platform == 'win32':
@@ -739,6 +739,17 @@ def main():
         # TODO(crbug.com/1472655): Remove this cherrypicking after the
         # cherrypicked commit is included in the checkout.
         GitCherryPick(RUST_SRC_DIR, '0081d64e4b8413219ddec5d1013d522edbf132')
+        RunCommand([
+            'git', '-C', RUST_SRC_DIR, 'remote', 'add', 'kxxt',
+            'https://github.com/kxxt/rust.git'
+        ],
+                   fail_hard=False)
+        RunCommand([
+            'git', '-C', RUST_SRC_DIR, 'fetch', 'kxxt',
+                      '3752291e2e5dddb38cffb36e8f89af2a0d20efc3'
+        ])
+        GitCherryPick(RUST_SRC_DIR,
+                      '3752291e2e5dddb38cffb36e8f89af2a0d20efc3')
 
         path = FetchBetaPackage('cargo', checkout_revision)
         if sys.platform == 'win32':
-- 
2.39.2

