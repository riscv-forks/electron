From 2c22bc7381470bb435ff132c48a6ad5d60c812fc Mon Sep 17 00:00:00 2001
From: kxxt <rsworktech@outlook.com>
Date: Sat, 10 Feb 2024 13:08:03 +0100
Subject: [PATCH] sysroot: riscv64 support

Patch-Filename: 0008-sysroot-riscv64-support.patch
---
 build/config/sysroot.gni                       |  4 +++-
 build/linux/sysroot_scripts/install-sysroot.py | 11 +++++++----
 build/linux/sysroot_scripts/sysroots.json      |  6 ++++++
 3 files changed, 16 insertions(+), 5 deletions(-)

diff --git a/build/config/sysroot.gni b/build/config/sysroot.gni
index dea380727e732..ba8ee11e69aea 100644
--- a/build/config/sysroot.gni
+++ b/build/config/sysroot.gni
@@ -21,7 +21,7 @@ declare_args() {
   # is empty, default sysroot is calculated.
   use_sysroot = current_cpu == "x86" || current_cpu == "x64" ||
                 current_cpu == "arm" || current_cpu == "arm64" ||
-                current_cpu == "mipsel" || current_cpu == "mips64el"
+                current_cpu == "mipsel" || current_cpu == "mips64el" || current_cpu == "riscv64"
 }
 
 if (sysroot == "") {
@@ -48,6 +48,8 @@ if (sysroot == "") {
       sysroot = "$target_sysroot_dir/debian_bullseye_arm-sysroot"
     } else if (current_cpu == "arm64") {
       sysroot = "$target_sysroot_dir/debian_bullseye_arm64-sysroot"
+    } else if (current_cpu == "riscv64") {
+      sysroot = "$target_sysroot_dir/debian_sid_riscv64-sysroot"
     } else {
       assert(false, "No linux sysroot for cpu: $target_cpu")
     }
diff --git a/build/linux/sysroot_scripts/install-sysroot.py b/build/linux/sysroot_scripts/install-sysroot.py
index 42842a184deb1..5ece1ac23768b 100755
--- a/build/linux/sysroot_scripts/install-sysroot.py
+++ b/build/linux/sysroot_scripts/install-sysroot.py
@@ -44,7 +44,7 @@ SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
 URL_PREFIX = 'https://commondatastorage.googleapis.com'
 URL_PATH = 'chrome-linux-sysroot/toolchain'
 
-VALID_ARCHS = ('arm', 'arm64', 'i386', 'amd64', 'mips', 'mips64el')
+VALID_ARCHS = ('amd64', 'i386', 'armhf', 'arm64', 'armel', 'mipsel', 'mips64el', 'riscv64')
 
 ARCH_TRANSLATIONS = {
     'x64': 'amd64',
@@ -85,16 +85,19 @@ def main(args):
 
   if options.print_key:
     arch = options.print_key
+    target_platform = 'sid' if arch == 'riscv64' else DEFAULT_TARGET_PLATFORM
     print(
-        GetSysrootDict(DEFAULT_TARGET_PLATFORM,
+        GetSysrootDict(target_platform,
                        ARCH_TRANSLATIONS.get(arch, arch))['Key'])
     return 0
   if options.arch:
-    InstallSysroot(DEFAULT_TARGET_PLATFORM,
+    target_platform = 'sid' if options.arch == 'riscv64' else DEFAULT_TARGET_PLATFORM
+    InstallSysroot(target_platform,
                    ARCH_TRANSLATIONS.get(options.arch, options.arch))
   elif options.all:
     for arch in VALID_ARCHS:
-      InstallSysroot(DEFAULT_TARGET_PLATFORM, arch)
+      target_platform = 'sid' if arch == 'riscv64' else DEFAULT_TARGET_PLATFORM
+      InstallSysroot(target_platform, arch)
   else:
     print('You much specify one of the options.')
     return 1
diff --git a/build/linux/sysroot_scripts/sysroots.json b/build/linux/sysroot_scripts/sysroots.json
index 8b56c81e3f287..f7ca0ce443040 100644
--- a/build/linux/sysroot_scripts/sysroots.json
+++ b/build/linux/sysroot_scripts/sysroots.json
@@ -40,5 +40,11 @@
         "Sha1Sum": "038b7b37c597647b218019f8d655871068d82029",
         "SysrootDir": "debian_bullseye_mips64el-sysroot",
         "Tarball": "debian_bullseye_mips64el_sysroot.tar.xz"
+    },
+    "sid_riscv64": {
+        "Key": "20240131T153825Z-1",
+        "Sha1Sum": "d8849d433e2c857b2a052812135115c91f96f54f",
+        "SysrootDir": "debian_sid_riscv64-sysroot",
+        "Tarball": "debian_sid_riscv64_sysroot.tar.xz"
     }
 }
-- 
2.39.2

