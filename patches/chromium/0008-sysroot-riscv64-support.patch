From def3478f7208ea395a2a4a166bd5bb037e9c35f6 Mon Sep 17 00:00:00 2001
From: kxxt <rsworktech@outlook.com>
Date: Sat, 10 Feb 2024 13:08:03 +0100
Subject: [PATCH] sysroot: riscv64 support

---
 build/config/sysroot.gni                       | 4 +++-
 build/linux/sysroot_scripts/install-sysroot.py | 9 ++++++---
 build/linux/sysroot_scripts/sysroots.json      | 7 +++++++
 3 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/build/config/sysroot.gni b/build/config/sysroot.gni
index 0f36edd9e5bb2..29b95c690aa74 100644
--- a/build/config/sysroot.gni
+++ b/build/config/sysroot.gni
@@ -22,7 +22,7 @@ declare_args() {
   use_sysroot =
       current_cpu == "x86" || current_cpu == "x64" || current_cpu == "arm" ||
       current_cpu == "arm64" || current_cpu == "mipsel" ||
-      current_cpu == "mips64el" || (current_cpu == "riscv64" && is_android)
+      current_cpu == "mips64el" || current_cpu == "riscv64"
 }
 
 if (sysroot == "") {
@@ -49,6 +49,8 @@ if (sysroot == "") {
       sysroot = "$target_sysroot_dir/debian_bullseye_armhf-sysroot"
     } else if (current_cpu == "arm64") {
       sysroot = "$target_sysroot_dir/debian_bullseye_arm64-sysroot"
+    } else if (current_cpu == "riscv64") {
+      sysroot = "$target_sysroot_dir/debian_sid_riscv64-sysroot"
     } else {
       assert(false, "No linux sysroot for cpu: $target_cpu")
     }
diff --git a/build/linux/sysroot_scripts/install-sysroot.py b/build/linux/sysroot_scripts/install-sysroot.py
index a2ac8305d8ca7..eadca7aeb7b76 100755
--- a/build/linux/sysroot_scripts/install-sysroot.py
+++ b/build/linux/sysroot_scripts/install-sysroot.py
@@ -35,7 +35,7 @@ from urllib.request import urlopen
 SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
 SRC_DIR = os.path.dirname(os.path.dirname(os.path.dirname(SCRIPT_DIR)))
 
-VALID_ARCHS = ('amd64', 'i386', 'armhf', 'arm64', 'armel', 'mipsel', 'mips64el')
+VALID_ARCHS = ('amd64', 'i386', 'armhf', 'arm64', 'armel', 'mipsel', 'mips64el', 'riscv64')
 
 ARCH_TRANSLATIONS = {
     'x64': 'amd64',
@@ -86,15 +86,18 @@ def main(args):
 
   if options.print_key:
     arch = options.print_key
+    target_platform = 'sid' if arch == 'riscv64' else DEFAULT_TARGET_PLATFORM
     print(
-        GetSysrootDict(sysroots_json_path, DEFAULT_TARGET_PLATFORM,
+        GetSysrootDict(sysroots_json_path, target_platform,
                        ARCH_TRANSLATIONS.get(arch, arch))['Key'])
     return 0
   if options.arch:
-    InstallSysroot(sysroots_json_path, DEFAULT_TARGET_PLATFORM,
+    target_platform = 'sid' if options.arch == 'riscv64' else DEFAULT_TARGET_PLATFORM
+    InstallSysroot(sysroots_json_path, target_platform,
                    ARCH_TRANSLATIONS.get(options.arch, options.arch))
   elif options.all:
     for arch in VALID_ARCHS:
+      target_platform = 'sid' if arch == 'riscv64' else DEFAULT_TARGET_PLATFORM
       InstallSysroot(sysroots_json_path, DEFAULT_TARGET_PLATFORM, arch)
   else:
     print('You much specify one of the options.')
diff --git a/build/linux/sysroot_scripts/sysroots.json b/build/linux/sysroot_scripts/sysroots.json
index 156d4c630ec39..39dc0299c482f 100644
--- a/build/linux/sysroot_scripts/sysroots.json
+++ b/build/linux/sysroot_scripts/sysroots.json
@@ -47,5 +47,12 @@
         "SysrootDir": "debian_bullseye_mipsel-sysroot",
         "Tarball": "debian_bullseye_mipsel_sysroot.tar.xz",
         "URL": "https://commondatastorage.googleapis.com/chrome-linux-sysroot/toolchain"
+    },
+    "sid_riscv64": {
+        "Key": "20240131T153825Z-1",
+        "Sha1Sum": "d8849d433e2c857b2a052812135115c91f96f54f",
+        "SysrootDir": "debian_sid_riscv64-sysroot",
+        "Tarball": "debian_sid_riscv64_sysroot.tar.xz",
+        "URL": "https://github.com/riscv-forks/electron/releases/download/sysroot-20240131T153825Z-1/debian_sid_riscv64_sysroot.tar.xz"
     }
 }
-- 
2.39.2

